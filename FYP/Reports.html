<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RFID Smart Parking - Reports (Live)</title>
  <style>
     * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: Arial, sans-serif;
      min-height: 100vh;
    }

    /* ===== LAYOUT ===== */
    .layout {
      display: grid;
      grid-template-columns: 240px 1fr;
      min-height: 100vh;
    }

    /* ===== SIDEBAR ===== */
    .sidebar {
      background: #f5f5f5;
      padding: 20px;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
    }

    .sidebar a {
      text-decoration: none;
      color: #333;
      padding: 16px;
      border-radius: 8px;
      margin: 4px 0;
      display: block;
      transition: background 0.2s;
      font-size: 16px;
    }

    .sidebar a:hover,
    .sidebar a.active {
      background: #4f46e5;
      color: white;
    }

    /* ===== RIGHT ===== */
    .right {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    /* ===== TOP BAR ===== */
    .title-bar {
      background: #f5f5f5;
      color: #333;
      padding: 14px 22px;
      font-size: clamp(18px, 3vw, 25px);
      font-weight: bold;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .title-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .title-left img {
      height: 38px;
      width: auto;
    }

    /* ===== PROFILE ===== */
    .profile-container { position: relative; }

    .profile-pic {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      object-fit: cover;
      cursor: pointer;
      border: 2px solid #4f46e5;
    }

    .dropdown-menu {
      display: none;
      position: absolute;
      right: 0;
      top: 50px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      width: 120px;
      text-align: center;
      z-index: 10;
    }

    .dropdown-menu a {
      display: block;
      padding: 10px;
      text-decoration: none;
      color: #333;
      font-size: 15px;
    }

    .dropdown-menu a:hover {
      background: #4f46e5;
      color: white;
      border-radius: 8px;
    }

    /* ===== MAIN ===== */
    .main {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    /* ===== HEADER ROW ===== */
    .header-row {
      display: column;
      grid-template-columns: 1fr 250px 250px;
      gap: 10px;
      align-items: center;
      margin-bottom: 30px;
    }

    .header-row h1 {
      font-size: clamp(22px, 4vw, 36px);
      margin: 0;
    }
    .header-row p { color: #555; margin: 10px 0 20px 0;}
    .filters {display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 30px 20px 15px 20px;}
    .filter-box {display: flex; flex-direction: column;}
    .filter-box label {font-weight: bold; margin: 8px 8px; font-size: 18px;}
    .filter-box select {padding: 15px; border-radius: 8px; border: 1px solid #ccc; font-size: 16px;}
    .export-buttons {text-align: right; margin: 0 20px 20px 0;}
    .export-buttons button {margin-left: 10px; padding: 12px 14px; border: none; color: white; background-color: #4f46e5; border-radius: 8px; cursor: pointer; font-weight: bold;}
    .export-buttons button:hover {background-color: #3730a3;}
    .stats-row {display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 25px;}
    .stats-box {background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 6px rgba(226, 70, 70, 0.1);}
    .stats-box h3 {margin-bottom: 10px; font-size: 20px; color: #333;}
    .stats-box p {margin: 5px 0; font-size: 40px; font-weight: bold;}
    .comparison p {font-size: 16px; color: rgb(162, 162, 162);}
    .charts-row {display: grid; grid-template-columns: 4fr 3fr; gap: 20px;}
    .chart-box {background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);}
    .chart-box h3 {margin-bottom: 15px; font-size: 20px;}
    canvas {width: 100% !important; height: 260px !important;}
    .small-note {font-size: 13px; color: #666;}
  </style>
</head>
<body>

  <div class="layout">

  <div class="sidebar">
    <a href="Dashboard.html">Dashboard</a>
    <a href="VehicleInfo.html">Vehicle Info</a>
    <a href="Alerts.html">Alerts</a>
    <a href="Reports.html" class="active">Reports</a>
  </div>

  <div class="right">

    <div class="title-bar">
      <div class="title-left">
        <img src="images/fyp-logo.png" alt="Company Logo">
        <span>RFID Smart Parking</span>
      </div>

      <div class="profile-container">
        <img src="images/profile.png" alt="Profile" class="profile-pic" id="profilePic">
        <div class="dropdown-menu" id="dropdownMenu">
          <a href="#" id="logoutLink">Logout</a>
        </div>
      </div>
    </div>

    <div class="main">
      <div class="header-row">
      <h1>Parking Reports</h1>
      <p class="subtitle">Generate and analyze parking system reports</p>
      </div>
      
      <div class="filters">
        <div class="filter-box">
          <label for="dateRange">Date Range</label>
          <select id="dateRange">
            <option value="1">Today</option>
            <option value="7">Last 7 Days</option>
            <option value="30">Last 30 Days</option>
            <option value="90">Last 90 Days</option>
          </select>
        </div>
        <div class="filter-box">
          <label for="zone">Zone</label>
          <select id="zone">
            <option value="all">All Zones</option>
            <option value="KICT">KICT</option>
            <option value="KOE">KOE</option>
            <option value="KOED">KOED</option>
            <option value="IRKHS">IRKHS</option>
            <option value="CELPAD">CELPAD</option>
            <option value="AIKOL">AIKOL</option>
            <option value="KENMS">KENMS</option>
            <option value="KAED">KAED</option>
          </select>
        </div>
        <div class="filter-box">
          <label for="userType">User Type</label>
          <select id="userType">
            <option value="all">All Users</option>
            <option value="Student">Student</option>
            <option value="Staff">Staff</option>
          </select>
        </div>
      </div>

      <div class="export-buttons">
        <button id="exportCsvBtn">Export CSV</button>
        <button id="exportPdfBtn">Export PDF</button>
      </div>

      <div class="stats-row">
        <div class="stats-box">
          <h3>Total Parking Sessions</h3>
          <p id="totalSessions">-</p>
          <div class="comparison"><p id="sessionsNote" class="small-note">Currently Parked</p></div>
        </div>

        <div class="stats-box">
          <h3>Average Session Duration</h3>
          <p id="avgDuration">-</p>
          <div class="comparison"><p class="small-note">Across completed sessions</p></div>
        </div>

        <div class="stats-box">
          <h3>Enforcement Actions</h3>
          <p id="enforcementCount">-</p>
          <div class="comparison"><p class="small-note">Active Alerts</p></div>
        </div>
      </div>

      <div class="charts-row">
        <div class="chart-box">
          <h3>Parking Session Trend</h3>
          <canvas id="sessionTrend"></canvas>
        </div>

        <div class="chart-box">
          <h3>Violation Type Distribution</h3>
          <canvas id="eventDistribution"></canvas>
        </div>
      </div>
    </div>
  </div>
  </div>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBZEK8mhES6mTDQYLvG3PVSGzuYwfCyx-Q",
      authDomain: "iium-parking-database.firebaseapp.com",
      projectId: "iium-parking-database",
      storageBucket: "iium-parking-database.firebasestorage.app",
      messagingSenderId: "73399677515",
      appId: "1:73399677515:web:e8fb4cb0738a0007dd93ce",
      measurementId: "G-GZ17Y9RC9Z"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const totalSessionsEl = document.getElementById('totalSessions');
    const avgDurationEl = document.getElementById('avgDuration');
    const enforcementCountEl = document.getElementById('enforcementCount');
    const dateRangeSelect = document.getElementById('dateRange');
    const zoneSelect = document.getElementById('zone');
    const userTypeSelect = document.getElementById('userType');
    const exportCsvBtn = document.getElementById('exportCsvBtn');
    const exportPdfBtn = document.getElementById('exportPdfBtn');

    // Profile elements
    const profilePic = document.getElementById('profilePic');
    const dropdownMenu = document.getElementById('dropdownMenu');
    const logoutLink = document.getElementById('logoutLink');

    let trendChart = null;
    let pieChart = null;
    let sessions = [];
    let alerts = [];

    function tsToDate(ts){ if(!ts) return null; if(ts.seconds!==undefined) return new Date(ts.seconds*1000); return new Date(ts);}
    function formatDurationMinutes(m){ if(isNaN(m)||m===0) return '0m'; const h=Math.floor(m/60); const mm=Math.round(m%60); return h?`${h}h ${mm}m`:`${mm}m`;}
    function startOfDay(d){ const x=new Date(d); x.setHours(0,0,0,0); return x;}
    function daysAgoDate(days){ const d=new Date(); d.setDate(d.getDate()-(days-1)); d.setHours(0,0,0,0); return d;}
    function formatDateKey(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}

    function computeStats(){
      const dr=dateRangeSelect.value;
      let earliest = null;
      if(dr!=='all') earliest=daysAgoDate(parseInt(dr));
      const zoneFilter = zoneSelect.value;
      const userTypeFilter = userTypeSelect.value;

      const filteredSessions = sessions.filter(s=>{
        const e=tsToDate(s.entry_time); if(!e) return false;
        if(earliest && e<earliest) return false;
        if(zoneFilter!=='all' && s.assigned_zone!==zoneFilter) return false;
        if(userTypeFilter!=='all' && s.owner_type!==userTypeFilter) return false;
        return true;
      });

      const currentlyParked = filteredSessions.filter(s=>!s.exit_time).length;
      const completed = filteredSessions.filter(s=>s.entry_time&&s.exit_time);
      const durationsMin = completed.map(s=>{
        const e=tsToDate(s.entry_time), x=tsToDate(s.exit_time);
        return (e&&x)?((x-e)/(1000*60)):NaN;
      }).filter(v=>!isNaN(v)&&v>=0);
      const avgMin = durationsMin.length?durationsMin.reduce((a,b)=>a+b,0)/durationsMin.length:NaN;

      const filteredAlerts = alerts.filter(a=>{
        const t=tsToDate(a.timestamp);
        if(earliest && (!t||t<earliest)) return false;
        if(zoneFilter!=='all' && a.assigned_zone!==zoneFilter) return false;
        return true;
      });

      const dayCount = dr==='all'?30:Math.min(parseInt(dr),90);
      const days=[];
      for(let i=dayCount-1;i>=0;i--){ const d=new Date(); d.setDate(d.getDate()-i); d.setHours(0,0,0,0); days.push(d);}
      const trendCounts=days.map(day=>{
        const key=formatDateKey(day);
        const cnt=filteredSessions.reduce((acc,s)=>{
          const e=tsToDate(s.entry_time);
          if(!e) return acc;
          if(formatDateKey(startOfDay(e))===key) return acc+1;
          return acc;
        },0);
        return {key,count:cnt};
      });

      const violationMap={};
      filteredAlerts.forEach(a=>{
        const t=a.violation_type||'Unknown';
        violationMap[t]=(violationMap[t]||0)+1;
      });

      totalSessionsEl.textContent=currentlyParked;
      avgDurationEl.textContent=Number.isFinite(avgMin)?formatDurationMinutes(avgMin):'-';
      enforcementCountEl.textContent=filteredAlerts.length;

      updateTrendChart(trendCounts);
      updatePieChart(violationMap);

      return {filteredSessions,filteredAlerts,avgMin};
    }

    function updateTrendChart(trendCounts){
      const labels=trendCounts.map(d=>{ const dd=new Date(d.key); return dd.toLocaleDateString('en-GB',{day:'2-digit',month:'short'});});
      const data=trendCounts.map(d=>d.count);
      if(trendChart){ trendChart.data.labels=labels; trendChart.data.datasets[0].data=data; trendChart.update(); return;}
      const ctx=document.getElementById('sessionTrend').getContext('2d');
      trendChart=new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'Parking Sessions',data,borderColor:'#4f46e5',backgroundColor:'rgba(79,70,229,0.2)',fill:true,tension:0.3}]},options:{maintainAspectRatio:false,scales:{y:{beginAtZero:true,ticks:{precision:0}}}}});
    }

    function updatePieChart(violationMap){
      const labels=Object.keys(violationMap);
      const data=labels.map(l=>violationMap[l]);
      if(pieChart){ pieChart.data.labels=labels; pieChart.data.datasets[0].data=data; pieChart.update(); return;}
      const ctx2=document.getElementById('eventDistribution').getContext('2d');
      pieChart=new Chart(ctx2,{type:'doughnut',data:{labels,datasets:[{data,backgroundColor:['#ef4444','#60a5fa']}]},options:{maintainAspectRatio:false,plugins:{legend:{position:'bottom'}}}});
    }

    exportCsvBtn.addEventListener('click',()=>{ exportCSV(computeStats()); });
    exportPdfBtn.addEventListener('click',()=>{ exportPDF(computeStats()); });

    function exportCSV(reportData){
      const rows=[['entry_time','exit_time','vehicle_id','duration_minutes']];
      reportData.filteredSessions.forEach(s=>{
        const e=tsToDate(s.entry_time);
        const x=tsToDate(s.exit_time);
        const dur=(e&&x)?((x-e)/(1000*60)).toFixed(2):'';
        rows.push([e?e.toISOString():'',x?x.toISOString():'',s.vehicle_id||'',dur]);
      });
      const csvContent=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob=new Blob([csvContent],{type:'text/csv;charset=utf-8;'});
      const link=document.createElement('a'); link.href=URL.createObjectURL(blob);
      const now=new Date();
      link.download=`parking_report_${now.toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`;
      document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }

    async function exportPDF(reportData) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: "pt", format: "a4" });

  const pageWidth = doc.internal.pageSize.getWidth();
  const now = new Date();

  // ===== IIUM LOGO =====
  const logoUrl = "images/iium-logo.png";
  const img = new Image();
  img.src = logoUrl;

  img.onload = () => {
    doc.addImage(img, "PNG", 40, 35, 70, 70);

    // ===== TITLE =====
    doc.setFont("helvetica", "bold");
    doc.setFontSize(18);
    doc.text(
      "IIUM RFID Smart Parking System",
      pageWidth / 2,
      55,
      { align: "center" }
    );

    doc.setFontSize(12);
    doc.setFont("helvetica", "normal");
    doc.text(
      "Parking Usage and Enforcement Report",
      pageWidth / 2,
      75,
      { align: "center" }
    );

    // ===== LINE =====
    doc.setLineWidth(0.8);
    doc.line(40, 115, pageWidth - 40, 115);

    // ===== METADATA =====
    let y = 140;
    doc.setFontSize(11);

    doc.text(`Generated On:`, 40, y);
    doc.text(now.toLocaleString("en-GB"), 160, y);

    y += 18;
    doc.text(`Date Range:`, 40, y);
    doc.text(document.getElementById("dateRange").selectedOptions[0].text, 160, y);

    y += 18;
    doc.text(`Zone:`, 40, y);
    doc.text(document.getElementById("zone").value, 160, y);

    y += 18;
    doc.text(`User Type:`, 40, y);
    doc.text(document.getElementById("userType").value, 160, y);

    // ===== STATISTICS =====
    y += 30;
    doc.setFont("helvetica", "bold");
    doc.text("Summary Statistics", 40, y);

    y += 16;
    doc.setFont("helvetica", "normal");

    doc.text(
      `Total Active Parking Sessions: ${reportData.filteredSessions.filter(s => !s.exit_time).length}`,
      40,
      y
    );

    y += 16;
    doc.text(
      `Average Session Duration: ${
        Number.isFinite(reportData.avgMin)
          ? formatDurationMinutes(reportData.avgMin)
          : "-"
      }`,
      40,
      y
    );

    y += 16;
    doc.text(
      `Total Enforcement Actions: ${reportData.filteredAlerts.length}`,
      40,
      y
    );

    // ===== TABLE =====
    y += 30;

    const sortedSessions = [...reportData.filteredSessions].sort((a, b) => {
  const ta = tsToDate(a.entry_time);
  const tb = tsToDate(b.entry_time);

  // Newest first (today â†’ past)
  return (tb ? tb.getTime() : 0) - (ta ? ta.getTime() : 0);
});

const tableRows = sortedSessions.map(s => {
  const e = tsToDate(s.entry_time);
  const x = tsToDate(s.exit_time);
  const dur =
    e && x ? ((x - e) / (1000 * 60)).toFixed(1) : "Ongoing";

  return [
    e ? e.toLocaleString("en-GB") : "-",
    x ? x.toLocaleString("en-GB") : "-",
    s.vehicle_id || "-",
    dur
  ];
});

    doc.autoTable({
      startY: y,
      head: [[
        "Entry Time",
        "Exit Time",
        "Vehicle ID",
        "Duration (minutes)"
      ]],
      body: tableRows,
      styles: {
        fontSize: 9,
        cellPadding: 6
      },
      headStyles: {
        fillColor: [0, 128, 128],
        textColor: 255,
        fontStyle: "bold"
      }
    });

    // ===== FOOTER =====
    const pageHeight = doc.internal.pageSize.getHeight();
    doc.setFontSize(9);
    doc.text(
      "Generated by IIUM RFID Smart Parking System (Academic Prototype)",
      pageWidth / 2,
      pageHeight - 30,
      { align: "center" }
    );

    doc.save(
      `IIUM_Parking_Report_${now.toISOString().slice(0,10)}.pdf`
    );
  };
}

    onSnapshot(collection(db,'PARKING_SESSION'),snapshot=>{ sessions=snapshot.docs.map(d=>d.data()); computeStats(); });
    onSnapshot(collection(db,'ALERTS'),snapshot=>{ alerts=snapshot.docs.map(d=>d.data()); computeStats(); });

    // Profile dropdown
    profilePic.addEventListener('click',()=>{ dropdownMenu.style.display=dropdownMenu.style.display==='block'?'none':'block'; });
    
    // Logout handler
    logoutLink.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      // Clear the session storage
      sessionStorage.removeItem('userLoggedIn');
      sessionStorage.removeItem('username');
      
      // Hide the dropdown menu
      dropdownMenu.style.display = 'none';
      
      // Redirect to login page
      window.location.href = "LoginPage.html";
    });
    
    window.addEventListener('click',(e)=>{ if(!profilePic.contains(e.target) && !dropdownMenu.contains(e.target)){ dropdownMenu.style.display='none'; } });

    dateRangeSelect.addEventListener('change',computeStats);
    zoneSelect.addEventListener('change',computeStats);
    userTypeSelect.addEventListener('change',computeStats);
  </script>
</body>
</html>