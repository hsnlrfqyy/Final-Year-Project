<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IIUM Smart Parking Dashboard</title>

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: Arial, sans-serif;
      min-height: 100vh;
    }

    /* ===== LAYOUT ===== */
    .layout {
      display: grid;
      grid-template-columns: 240px 1fr;
      min-height: 100vh;
    }

    /* ===== SIDEBAR ===== */
    .sidebar {
      background: #f5f5f5;
      padding: 20px;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
    }

    .sidebar a {
      text-decoration: none;
      color: #333;
      padding: 16px;
      border-radius: 8px;
      margin: 4px 0;
      display: block;
      transition: background 0.2s;
      font-size: 16px;
    }

    .sidebar a:hover,
    .sidebar a.active {
      background: #4f46e5;
      color: white;
    }

    /* ===== RIGHT ===== */
    .right {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    /* ===== TOP BAR ===== */
    .title-bar {
      background: #f5f5f5;
      color: #333;
      padding: 14px 22px;
      font-size: clamp(18px, 3vw, 25px);
      font-weight: bold;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .title-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .title-left img {
      height: 38px;
      width: auto;
    }

    /* ===== PROFILE ===== */
    .profile-container { position: relative; }

    .profile-pic {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      object-fit: cover;
      cursor: pointer;
      border: 2px solid #4f46e5;
    }

    .dropdown-menu {
      display: none;
      position: absolute;
      right: 0;
      top: 50px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      width: 120px;
      text-align: center;
      z-index: 10;
    }

    .dropdown-menu a {
      display: block;
      padding: 10px;
      text-decoration: none;
      color: #333;
      font-size: 15px;
    }

    .dropdown-menu a:hover {
      background: #4f46e5;
      color: white;
      border-radius: 8px;
    }

    /* ===== MAIN ===== */
    .main {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    /* ===== HEADER ROW ===== */
    .header-row {
      display: grid;
      grid-template-columns: 1fr 250px 250px;
      gap: 20px;
      align-items: center;
      margin-bottom: 30px;
    }

    .header-row h1 {
      font-size: clamp(22px, 4vw, 36px);
      margin: 0;
    }

    select {
      padding: 14px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 15px;
      width: 100%;
    }

    /* ===== GRID ===== */
    .grid {
      display: grid;
      gap: 20px;
      margin-bottom: 35px;
    }

    .stats-row { grid-template-columns: repeat(3, 1fr); }
    .system-row { grid-template-columns: repeat(2, 1fr); }
    .trend-row { grid-template-columns: 1fr; }

    /* ===== CARD ===== */
    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .card h3 {
      margin: 0;
      font-size: 17px;
      color: #555;
      font-weight: 700;
    }

    .metric {
      font-size: clamp(32px, 6vw, 48px);
      margin: 6px 0;
      font-weight: 500;
      color: #111;
      line-height: 1;
    }

    .card small {
      color: #6b7280;
      font-size: 13px;
      margin-top: 6px;
      display: block;
    }

    .system-status {
      font-size: 26px;
      font-weight: 700;
      margin-top: 6px;
    }

    .system-ok { color: #16a34a; }
    .system-err { color: #dc2626; }

    /* ===== CHART ===== */
    .chart-box {
      background: white;
      border-radius: 12px;
      padding: 18px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    }

    canvas {
      width: 100% !important;
      height: 320px !important;
      display: block;
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 1024px) {
      .header-row {
        grid-template-columns: 1fr 1fr;
        row-gap: 15px;
      }
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }

      .sidebar {
        display: none;
      }

      .stats-row {
        grid-template-columns: 1fr;
      }

      .system-row {
        grid-template-columns: 1fr;
      }

      canvas {
        height: 260px !important;
      }
    }
  </style>
</head>

<body>

<div class="layout">

  <!-- Sidebar -->
  <div class="sidebar">
    <a href="dashboard.html" class="active">Dashboard</a>
    <a href="VehicleInfo.html">Vehicle Info</a>
    <a href="Alerts.html">Alerts</a>
    <a href="Reports.html">Reports</a>
  </div>

  <!-- Right -->
  <div class="right">

    <!-- Title Bar -->
    <div class="title-bar">
      <div class="title-left">
        <img src="images/fyp-logo.png" alt="Company Logo">
        <span>RFID Smart Parking</span>
      </div>

      <div class="profile-container">
        <img src="images/profile.png" alt="Profile" class="profile-pic" id="profilePic">
        <div class="dropdown-menu" id="dropdownMenu">
          <a href="LoginPage.html" id="logoutLink">Logout</a>
        </div>
      </div>
    </div>

    <!-- Main -->
    <div class="main">

      <div class="header-row">
        <h1>Dashboard Overview</h1>

        <div>
          <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:6px;font-weight:700;">Date Range</label>
          <select id="dateRange">
            <option value="30">Last 30 Days</option>
            <option value="7">Last 7 Days</option>
            <option value="1">Today</option>
          </select>
        </div>

        <div>
          <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:6px;font-weight:700;">User Type</label>
          <select id="userType">
            <option value="all">All Users</option>
            <option value="Staff">Staff</option>
            <option value="Student">Students</option>
          </select>
        </div>
      </div>

      <!-- Stats -->
      <div class="grid stats-row">
        <div class="card">
          <h3>Current Parked Vehicles</h3>
          <div id="totalParked" class="metric">—</div>
          <small>Vehicles in Campus</small>
        </div>

        <div class="card">
          <h3>Available Parking Spots</h3>
          <div id="availableSpots" class="metric">—</div>
          <small>Overall Parking Records</small>
        </div>

        <div class="card">
          <h3>Active Alerts</h3>
          <div id="activeAlerts" class="metric">—</div>
          <small>Recorded Violations</small>
        </div>
      </div>

      <!-- System -->
      <div class="grid system-row">
        <div class="card">
          <h3>System Health</h3>
          <div id="systemHealth" class="system-status system-ok">Operational</div>
          <small>Firestore connection status</small>
        </div>

        <div class="card">
          <h3>Recent Entries</h3>
          <div id="recentAccesses" class="metric">—</div>
          <small>Recorded Entries</small>
        </div>
      </div>

      <!-- Trend -->
      <div class="grid trend-row">
        <div class="chart-box">
          <h3>Parking Occupancy Trend</h3>
          <small style="color:#6b7280;">Each line represents a Kulliyyah.</small>
          <canvas id="occupancyTrend"></canvas>
        </div>
      </div>

    </div>
  </div>
</div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBZEK8mhES6mTDQYLvG3PVSGzuYwfCyx-Q",
      authDomain: "iium-parking-database.firebaseapp.com",
      projectId: "iium-parking-database",
      storageBucket: "iium-parking-database.firebasestorage.app",
      messagingSenderId: "73399677515",
      appId: "1:73399677515:web:e8fb4cb0738a0007dd93ce",
      measurementId: "G-GZ17Y9RC9Z"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // UI elements
    const dateRangeEl = document.getElementById('dateRange');
    const userTypeEl = document.getElementById('userType');
    const totalParkedEl = document.getElementById('totalParked');
    const availableSpotsEl = document.getElementById('availableSpots');
    const activeAlertsEl = document.getElementById('activeAlerts');
    const systemHealthEl = document.getElementById('systemHealth');
    const recentAccessesEl = document.getElementById('recentAccesses');

    // Zones (exact names you specified)
    const ZONES = ["KICT","KOE","KOED","CELPAD","AIKOL","KENMS","KAED","IRKHS"];

    // Data caches
    let sessions = [];
    let alerts = [];

    // Chart instance
    let occupancyChart = null;

    // Helpers
    function tsToDate(ts) {
      if (!ts) return null;
      if (ts.seconds !== undefined) return new Date(ts.seconds * 1000);
      const d = new Date(ts);
      return isNaN(d) ? null : d;
    }

    function sessionRepresentativeDate(s) {
      return tsToDate(s.entry_time) || tsToDate(s.exit_time) || null;
    }

    function buildDateList(daysCount) {
      const out = [];
      for (let i = daysCount - 1; i >= 0; i--) {
        const d = new Date();
        d.setHours(0,0,0,0);
        d.setDate(d.getDate() - i);
        out.push(new Date(d));
      }
      return out;
    }

    function formatLabel(d) {
      return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
    }

    function computeAndRender() {
      try {
        const dr = Number(dateRangeEl.value) || 7;
        const now = new Date();
        const earliest = new Date(); earliest.setHours(0,0,0,0); earliest.setDate(earliest.getDate() - (dr - 1));
        const userFilter = userTypeEl.value;

        // filter sessions by representative date and user type
        const filteredSessions = sessions.filter(s => {
          const rep = sessionRepresentativeDate(s);
          if (!rep) return false;
          if (rep < earliest) return false;
          if (rep > now) return false;
          if (userFilter !== 'all' && ((s.owner_type || s.ownerType || '') !== userFilter)) return false;
          return true;
        });

        // total parked (exit_time absent)
        const totalParked = filteredSessions.filter(s => !s.exit_time).length;
        const capacity = 1000;
        const available = Math.max(0, capacity - totalParked);

        // active alerts: status === "Active" and in range if timestamp exists
        const filteredAlerts = alerts.filter(a => {
          const t = tsToDate(a.timestamp);
          if (t) {
            if (t < earliest || t > now) return false;
          }
          return (a.status || '').toString().toLowerCase() === 'active';
        });

        const activeAlertCount = filteredAlerts.length;
        const recentCount = filteredSessions.length;

        // Prepare trend data: count entries by entry_time date and zone
        const days = buildDateList(dr);
        const dateKeys = days.map(d => d.toISOString().slice(0,10));
        const zoneSeries = {};
        ZONES.forEach(z => zoneSeries[z] = dateKeys.map(() => 0));

        filteredSessions.forEach(s => {
          const e = tsToDate(s.entry_time);
          if (!e) return;
          const key = e.toISOString().slice(0,10);
          const idx = dateKeys.indexOf(key);
          if (idx === -1) return;
          const zone = (s.assigned_zone || s.zone || '').toString();
          if (ZONES.includes(zone)) zoneSeries[zone][idx] += 1;
        });

        // Update DOM metrics
        totalParkedEl.textContent = totalParked;
        availableSpotsEl.textContent = available;
        activeAlertsEl.textContent = activeAlertCount;
        recentAccessesEl.textContent = recentCount;

        // Chart update
        const labels = days.map(formatLabel);
        const palette = ['#2563eb','#ef4444','#f59e0b','#10b981','#8b5cf6','#ec4899','#fb923c','#64748b'];
        const datasets = ZONES.map((zone, i) => ({
          label: zone,
          data: zoneSeries[zone],
          borderColor: palette[i % palette.length],
          backgroundColor: palette[i % palette.length],
          fill: false,
          tension: 0.2,
          pointRadius: 3,
          borderWidth: 2
        }));

        if (!occupancyChart) {
          const ctx = document.getElementById('occupancyTrend').getContext('2d');
          occupancyChart = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets },
            options: {
              maintainAspectRatio: false,
              responsive: true,
              interaction: { mode:'index', intersect:false },
              plugins: { legend: { position: 'bottom' } },
              scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
            }
          });
        } else {
          occupancyChart.data.labels = labels;
          occupancyChart.data.datasets = datasets;
          occupancyChart.update();
        }
      } catch (err) {
        console.error("computeAndRender error:", err);
      }
    }

    // System health tracking flags
    let sessionsListenerActive = false;
    let alertsListenerActive = false;
    function updateSystemStatus() {
      const el = systemHealthEl;
      if (sessionsListenerActive && alertsListenerActive) {
        el.textContent = 'Operational';
        el.className = 'system-status system-ok';
      } else {
        el.textContent = 'Error';
        el.className = 'system-status system-err';
      }
    }

    // Firebase realtime listeners
    try {
      const sessionsRef = collection(db, 'PARKING_SESSION');
      onSnapshot(sessionsRef, snapshot => {
        sessionsListenerActive = true;
        updateSystemStatus();
        sessions = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        sessions.sort((a,b) => (b.entry_time?.seconds||0) - (a.entry_time?.seconds||0));
        computeAndRender();
      }, err => {
        console.error('PARKING_SESSION snapshot error:', err);
        sessionsListenerActive = false;
        updateSystemStatus();
      });
    } catch (e) {
      console.error('PARKING_SESSION listener failed:', e);
      sessionsListenerActive = false;
      updateSystemStatus();
    }

    try {
      const alertsRef = collection(db, 'ALERTS');
      onSnapshot(alertsRef, snapshot => {
        alertsListenerActive = true;
        updateSystemStatus();
        alerts = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        alerts.sort((a,b) => (b.timestamp?.seconds||0) - (a.timestamp?.seconds||0));
        computeAndRender();
      }, err => {
        console.error('ALERTS snapshot error:', err);
        alertsListenerActive = false;
        updateSystemStatus();
      });
    } catch (e) {
      console.error('ALERTS listener failed:', e);
      alertsListenerActive = false;
      updateSystemStatus();
    }

    // UI events
    dateRangeEl.addEventListener('change', computeAndRender);
    userTypeEl.addEventListener('change', computeAndRender);

    // profile dropdown simple behavior
    const profilePic = document.getElementById("profilePic");
    const dropdownMenu = document.getElementById("dropdownMenu");
    const logoutLink = document.getElementById("logoutLink");
    
    profilePic.addEventListener("click", () => {
      dropdownMenu.style.display = dropdownMenu.style.display === "block" ? "none" : "block";
    });
    
    // Logout handler
    logoutLink.addEventListener("click", (e) => {
      e.preventDefault();
      sessionStorage.removeItem('userLoggedIn');
      sessionStorage.removeItem('username');
      window.location.href = "LoginPage.html";
    });
    
    window.addEventListener("click", (e) => {
      if (!profilePic.contains(e.target) && !dropdownMenu.contains(e.target)) {
        dropdownMenu.style.display = "none";
      }
    });

    // initial render
    computeAndRender();
  </script>
</body>
</html>