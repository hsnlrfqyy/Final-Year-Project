<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RFID Smart Parking - Alerts</title>

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: Arial, sans-serif;
      min-height: 100vh;
    }

    /* ===== LAYOUT ===== */
    .layout {
      display: grid;
      grid-template-columns: 240px 1fr;
      min-height: 100vh;
    }

    /* ===== SIDEBAR ===== */
    .sidebar {
      background: #f5f5f5;
      padding: 20px;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
    }

    .sidebar a {
      text-decoration: none;
      color: #333;
      padding: 16px;
      border-radius: 8px;
      margin: 4px 0;
      display: block;
      transition: background 0.2s;
      font-size: 16px;
    }

    .sidebar a:hover,
    .sidebar a.active {
      background: #4f46e5;
      color: white;
    }

    /* ===== RIGHT ===== */
    .right {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    /* ===== TITLE BAR ===== */
    .title-bar {
      background: #f5f5f5;
      padding: 14px 22px;
      font-size: clamp(18px, 3vw, 25px);
      font-weight: bold;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .title-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .title-left img {
      height: 38px;
    }

    /* ===== PROFILE ===== */
    .profile-container { position: relative; }

    .profile-pic {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid #4f46e5;
    }

    .dropdown-menu {
      display: none;
      position: absolute;
      right: 0;
      top: 50px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      width: 120px;
      text-align: center;
      z-index: 10;
    }

    .dropdown-menu a {
      display: block;
      padding: 10px;
      color: #333;
      text-decoration: none;
    }

    .dropdown-menu a:hover {
      background: #4f46e5;
      color: white;
    }

    /* ===== MAIN ===== */
    .main {
      flex: 1;
      padding: 20px;
      background: #fafafa;
      overflow-y: auto;
    }

    h1 {
      margin: 0 0 15px;
      font-size: clamp(22px, 4vw, 35px);
    }

    /* ===== CARDS ===== */
    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    }

    .card h2 {
      margin-bottom: 15px;
      font-size: 20px;
    }

    /* ===== SUMMARY ===== */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
    }

    .summary-item {
      background: #f9fafb;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
    }

    .summary-item h3 {
      margin: 0;
      font-size: 16px;
      color: #555;
    }

    .summary-item p {
      font-size: 26px;
      margin-top: 8px;
      font-weight: bold;
    }

    /* ===== TABLE ===== */
    .table-wrapper {
      overflow-x: auto;
    }

    table {
      width: 100%;
      min-width: 900px;
      border-collapse: collapse;
      font-size: 15px;
    }

    th, td {
      padding: 14px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }

    th {
      background: #f2f2f2;
    }

    tr:hover { background: #f9f9f9; }

    /* ===== BUTTONS ===== */
    .action-buttons {
      display: flex;
      gap: 8px;
    }

    .btn {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      font-weight: bold;
      border: none;
    }

    .btn-ack {
      background: #fff;
      color: #333;
      border: 1px solid #ccc;
    }

    .btn-resolve {
      background: #dc2626;
      color: white;
    }

    /* ===== SEVERITY ===== */
    .severity-high { background: #fee2e2;color: #dc2626;;padding:4px 8px;border-radius:6px;font-weight:bold; }
    .severity-medium { background: #fef3c7;color: #d97706;;padding:4px 8px;border-radius:6px;font-weight:bold; }
    .severity-low { background: #dbeafe;color: #2563eb;;padding:4px 8px;border-radius:6px;font-weight:bold; }

    .status-active,.status-resolved,.status-acknowledged {
      padding: 4px 8px;
      border-radius: 6px;
      font-weight: bold;
      border: 2px solid;
      background: white;
    }

    .status-active { border-color:#2563eb;color:#2563eb; }
    .status-resolved { border-color:#16a34a;color:#16a34a; }
    .status-acknowledged { border-color:#f59e0b;color:#f59e0b; }

    /* ===== PAGINATION ===== */
    .pagination {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
    }

    .pagination button {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: white;
      cursor: pointer;
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
      .sidebar { display: none; }
      .summary-grid { grid-template-columns: 1fr; }
      table { min-width: 700px; }
    }
  </style>
</head>

<body>

<div class="layout">

  <!-- Sidebar -->
  <div class="sidebar">
    <a href="Dashboard.html">Dashboard</a>
    <a href="VehicleInfo.html">Vehicle Info</a>
    <a href="Alerts.html" class="active">Alerts</a>
    <a href="Reports.html">Reports</a>
  </div>

  <!-- Right -->
  <div class="right">

    <div class="title-bar">
      <div class="title-left">
        <img src="images/fyp-logo.png">
        <span>RFID Smart Parking</span>
      </div>
      <div class="profile-container">
        <img src="images/profile.png" class="profile-pic" id="profilePic">
        <div class="dropdown-menu" id="dropdownMenu">
          <a href="#" id="logoutLink">Logout</a>
        </div>
      </div>
    </div>

    <div class="main">
      <h1>Alert Monitoring</h1>

      <div class="card">
        <h2>Alert Summary</h2>
        <div class="summary-grid">
          <div class="summary-item"><h3>Total Alerts</h3><p id="totalAlerts">-</p></div>
          <div class="summary-item"><h3>High</h3><p id="errorCount" style="color:red;">-</p></div>
          <div class="summary-item"><h3>Medium</h3><p id="warningCount" style="color:orange;">-</p></div>
          <div class="summary-item"><h3>Low</h3><p id="infoCount" style="color:#4f46e5;">-</p></div>
        </div>
      </div>

      <div class="card">
        <h2>Alerts</h2>

        <div class="table-wrapper">
          <table id="alertsTable">
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>Vehicle ID</th>
                <th>Zone</th>
                <th>Violation Type</th>
                <th>Severity</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="pagination">
          <button id="prevBtn">&lt;</button>
          <p id="pageIndicator"></p>
          <button id="nextBtn">&gt;</button>
        </div>
      </div>

    </div>
  </div>
</div>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {getFirestore,collection,onSnapshot,doc,updateDoc,deleteDoc} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBZEK8mhES6mTDQYLvG3PVSGzuYwfCyx-Q",
      authDomain: "iium-parking-database.firebaseapp.com",
      projectId: "iium-parking-database",
      storageBucket: "iium-parking-database.firebasestorage.app",
      messagingSenderId: "73399677515",
      appId: "1:73399677515:web:e8fb4cb0738a0007dd93ce",
      measurementId: "G-GZ17Y9RC9Z"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let alerts = [];
    let currentPage = 1;
    const rowsPerPage = 10;

    // DOM Elements
    const profilePic = document.getElementById("profilePic");
    const dropdownMenu = document.getElementById("dropdownMenu");
    const logoutLink = document.getElementById("logoutLink");

    // Profile dropdown
    profilePic.addEventListener("click", (e) => {
      e.stopPropagation();
      dropdownMenu.style.display = dropdownMenu.style.display === "block" ? "none" : "block";
    });
    
    window.addEventListener("click", (e) => {
      if (!profilePic.contains(e.target) && !dropdownMenu.contains(e.target)) {
        dropdownMenu.style.display = "none";
      }
    });

    // Logout handler
    logoutLink.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      // Clear the session storage
      sessionStorage.removeItem('userLoggedIn');
      sessionStorage.removeItem('username');
      
      // Hide the dropdown menu
      dropdownMenu.style.display = "none";
      
      // Redirect to login page
      window.location.href = "LoginPage.html";
    });

    function formatTimestamp(ts) {
      if (!ts) return "-";
      if (ts.seconds) {
        const date = new Date(ts.seconds * 1000);
        return date.toLocaleString("en-MY", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit", hour12:false }).replace(",", "");
      }
      return ts;
    }

    function renderTable() {
      const tbody = document.querySelector("#alertsTable tbody");
      tbody.innerHTML = "";

      const start = (currentPage - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const pageData = alerts.slice(start, end);

      pageData.forEach((a, index) => {
        const row = `
          <tr data-id="${a.id}">
            <td>${formatTimestamp(a.timestamp)}</td>
            <td>${a.vehicle_id}</td>
            <td>${a.assigned_zone}</td>
            <td>${a.violation_type}</td>
            <td><span class="severity-${a.severity.toLowerCase()}">${a.severity}</span></td>
            <td><span class="status-${a.status.toLowerCase()}">${a.status}</span></td>
            <td class="action-buttons">
              <button class="btn btn-ack">Acknowledge</button>
              <button class="btn btn-resolve">Resolve</button>
            </td>
          </tr>`;
        tbody.insertAdjacentHTML("beforeend", row);
      });

      document.getElementById("pageIndicator").textContent =
        `Page ${currentPage} of ${Math.ceil(alerts.length / rowsPerPage)}`;

      // Add button click listeners
      tbody.querySelectorAll(".btn-ack").forEach((btn, i) => {
        btn.addEventListener("click", async () => {
          const alertId = pageData[i].id;
          await updateDoc(doc(db, "ALERTS", alertId), { status: "Acknowledged" });
        });
      });

      tbody.querySelectorAll(".btn-resolve").forEach((btn, i) => {
  btn.addEventListener("click", async () => {
    const alertId = pageData[i].id;

    if (!confirm("Are you sure you want to resolve and remove this alert?")) return;

    try {
      await deleteDoc(doc(db, "ALERTS", alertId));
      console.log("Alert deleted:", alertId);
    } catch (err) {
      console.error("Delete failed:", err);
      alert("Failed to delete alert. Check Firestore rules.");
    }
  });
});

    }

    document.getElementById("prevBtn").addEventListener("click", () => {
      if (currentPage > 1) { currentPage--; renderTable(); }
    });
    document.getElementById("nextBtn").addEventListener("click", () => {
      if (currentPage < Math.ceil(alerts.length / rowsPerPage)) { currentPage++; renderTable(); }
    });

    // Firestore real-time listener
    const alertsRef = collection(db, "ALERTS");
    onSnapshot(alertsRef, (snapshot) => {
      alerts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

      alerts.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

      document.getElementById("totalAlerts").textContent = alerts.length;
      document.getElementById("errorCount").textContent = alerts.filter(a => a.severity === "High").length;
      document.getElementById("warningCount").textContent = alerts.filter(a => a.severity === "Medium").length;
      document.getElementById("infoCount").textContent = alerts.filter(a => a.severity === "Low").length;

      renderTable();
    });
  </script>
</body>
</html>